# é…ç½®ç»“æ„é‡æ„éœ€æ±‚æ–‡æ¡£

**æ–‡æ¡£æ—¥æœŸï¼š** 2025-11-19
**ç‰ˆæœ¬ï¼š** v1.0

---

## 1. èƒŒæ™¯ä¸é—®é¢˜

### ä¸šåŠ¡èƒŒæ™¯

GlitchTip Webhook RelayæœåŠ¡ä½œä¸ºGlitchTipé”™è¯¯è¿½è¸ªæœåŠ¡ä¸é£ä¹¦æœºå™¨äººä¹‹é—´çš„ä¸­ä»‹ï¼Œå°†GlitchTipçš„å‘Šè­¦æ¶ˆæ¯è½¬å‘åˆ°é£ä¹¦å¹³å°ã€‚ä¸€ä¸ªGlitchTipæœåŠ¡å¯ä»¥åŒ…å«å¤šä¸ªé¡¹ç›®(project)ï¼Œæ¯ä¸ªé¡¹ç›®å¯ä»¥é…ç½®ç‹¬ç«‹çš„å‘Šè­¦è§„åˆ™(webhook)ã€‚

### å½“å‰é—®é¢˜

1. **å›ºå®šè·¯ç”±é™åˆ¶**ï¼šå½“å‰ä½¿ç”¨å›ºå®šendpoint `/webhook/glitchtip`ï¼Œæ— æ³•åŒºåˆ†ä¸åŒé¡¹ç›®çš„å‘Šè­¦
2. **ç¼ºä¹è·¯ç”±çµæ´»æ€§**ï¼šæ‰€æœ‰å‘Šè­¦éƒ½è½¬å‘åˆ°é…ç½®ä¸­æ‰€æœ‰å¯ç”¨çš„webhookï¼Œæ— æ³•ç²¾ç¡®æ§åˆ¶
3. **é…ç½®æ˜ å°„ä¸æ¸…æ™°**ï¼šæ— æ³•é€šè¿‡URLç›´æ¥æŒ‡å®šç›®æ ‡webhooké…ç½®
4. **é¡¹ç›®éš”ç¦»ä¸è¶³**ï¼šä¸åŒé¡¹ç›®çš„å‘Šè­¦æ— æ³•ç‹¬ç«‹ç®¡ç†å’Œè½¬å‘

### ç—›ç‚¹åœºæ™¯

**åœºæ™¯1ï¼šå¤šé¡¹ç›®åœºæ™¯**
- é¡¹ç›®Aéœ€è¦è½¬å‘åˆ°é£ä¹¦ç¾¤ç»„1
- é¡¹ç›®Béœ€è¦è½¬å‘åˆ°é£ä¹¦ç¾¤ç»„2
- å½“å‰æ‰€æœ‰é¡¹ç›®éƒ½è½¬å‘åˆ°ç›¸åŒçš„webhookï¼Œæ— æ³•åŒºåˆ†

**åœºæ™¯2ï¼šå¤šç›®æ ‡éœ€æ±‚**
- é¡¹ç›®Aéœ€è¦åŒæ—¶è½¬å‘åˆ°å¤šä¸ªé£ä¹¦ç¾¤ç»„ï¼ˆç›‘æ§ç¾¤+å¼€å‘ç¾¤ï¼‰
- é¡¹ç›®Båªéœ€è¦è½¬å‘åˆ°ç‰¹å®šç¾¤ç»„
- å½“å‰æ— æ³•ç²¾ç¡®æ§åˆ¶è½¬å‘ç›®æ ‡

**åœºæ™¯3ï¼šæµ‹è¯•ä¸ç”Ÿäº§**
- ç”Ÿäº§ç¯å¢ƒwebhookä¸æµ‹è¯•ç¯å¢ƒwebhookéœ€è¦éš”ç¦»
- å½“å‰ç¼ºä¹åŸºäºè·¯ç”±çš„ç¯å¢ƒéš”ç¦»æœºåˆ¶

---

## 2. éœ€æ±‚ç›®æ ‡

### 2.1 åŠŸèƒ½ç›®æ ‡

1. **åŠ¨æ€è·¯ç”±æ”¯æŒ**ï¼šé€šè¿‡URLè·¯å¾„å‚æ•°åŠ¨æ€åŒ¹é…webhooké…ç½®
2. **ç²¾ç¡®è½¬å‘æ§åˆ¶**ï¼šåŸºäºè·¯ç”±ç²¾ç¡®æ§åˆ¶æ¶ˆæ¯è½¬å‘ç›®æ ‡
3. **é…ç½®éš”ç¦»**ï¼šä¸åŒè·¯ç”±æŒ‡å‘ä¸åŒçš„webhooké…ç½®
4. **å¤šç›®æ ‡æ”¯æŒ**ï¼šæ”¯æŒä¸€ä¸ªè·¯ç”±å¯¹åº”å¤šä¸ªwebhookç›®æ ‡
5. **è½¬å‘ç­–ç•¥å¯é…ç½®**ï¼šå¯é…ç½®å¤šç›®æ ‡è½¬å‘çš„è¡Œä¸ºï¼ˆå¹¶è¡Œã€é¡ºåºã€æ¡ä»¶ç­‰ï¼‰

### 2.2 éåŠŸèƒ½ç›®æ ‡

1. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰é…ç½®æ ¼å¼çš„å…¼å®¹æ€§
2. **æ˜“ç”¨æ€§**ï¼šé…ç½®ç®€å•ç›´è§‚ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
3. **æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥æ·»åŠ æ–°çš„è½¬å‘ç­–ç•¥å’Œç›®æ ‡ç±»å‹
4. **æ€§èƒ½**ï¼šä¿æŒç°æœ‰æœåŠ¡çš„æ€§èƒ½æ°´å¹³

---

## 3. è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šåŸºäºGroupåç§°çš„ç²¾ç¡®åŒ¹é…

**è·¯ç”±è®¾è®¡**
```
/i/{group_name}/{suffix}
```

**ç¤ºä¾‹è·¯ç”±**
- `/i/feishu_robot1/webhook` â†’ åŒ¹é…é…ç½®ä¸­name="feishu_robot1"çš„webhook
- `/i/monitor_group/alert` â†’ åŒ¹é…é…ç½®ä¸­name="monitor_group"çš„webhook
- `/i/dev_team/notify` â†’ åŒ¹é…é…ç½®ä¸­name="dev_team"çš„webhook

**é…ç½®ç»“æ„**
```toml
[[feishu_webhooks]]
name = "feishu_robot1"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/xxx1"
enabled = true
forwarding_strategy = "all"  # è½¬å‘ç­–ç•¥ï¼šall, first, round_robin

[[feishu_webhooks]]
name = "monitor_group"
url = ["https://open.feishu.cn/open-apis/bot/v2/hook/xxx2", "https://open.feishu.cn/open-apis/bot/v2/hook/xxx3"]
enabled = true
```

**è·¯ç”±å¤„ç†é€»è¾‘**
1. è§£æURLè·¯å¾„ï¼Œæå–`{group_name}`
2. åœ¨é…ç½®ä¸­æŸ¥æ‰¾`name={group_name}`çš„webhooké…ç½®
3. æ‰§è¡Œå¯¹åº”çš„è½¬å‘ç­–ç•¥
4. è¿”å›è½¬å‘ç»“æœ

**ä¼˜ç‚¹**
- é…ç½®æ¸…æ™°ç›´è§‚ï¼Œé€šè¿‡nameç²¾ç¡®åŒ¹é…
- æ˜“äºç†è§£å’Œç»´æŠ¤
- è·¯ç”±è¯­ä¹‰æ˜ç¡®

**ç¼ºç‚¹**
- éœ€è¦é¢„å…ˆå®šä¹‰æ‰€æœ‰group_name
- è·¯ç”±è§£æéœ€è¦é¢å¤–çš„é€»è¾‘

---

### æ–¹æ¡ˆäºŒï¼šåŸºäºè·¯ç”±å‚æ•°çš„å¤šç›®æ ‡é…ç½®

**è·¯ç”±è®¾è®¡**
```
/i/{project_id}/{environment}/{handler}
```

**ç¤ºä¾‹è·¯ç”±**
- `/i/project_a/production/alert` â†’ é¡¹ç›®Aç”Ÿäº§ç¯å¢ƒçš„å‘Šè­¦
- `/i/project_b/testing/notify` â†’ é¡¹ç›®Bæµ‹è¯•ç¯å¢ƒçš„é€šçŸ¥

**é…ç½®ç»“æ„**
```toml
[routing]
# åŸºäºé¡¹ç›®å’Œç¯å¢ƒçš„å¤šå±‚é…ç½®
[projects.project_a]
production = ["feishu_prod_1", "feishu_prod_2"]
staging = ["feishu_staging"]

[projects.project_b]
production = ["feishu_b_prod"]

# Webhooké…ç½®ä¿æŒç‹¬ç«‹
[feishu_webhooks.feishu_prod_1]
url = "https://..."
enabled = true
```

**è·¯ç”±å¤„ç†é€»è¾‘**
1. è§£æURLè·¯å¾„ï¼Œæå–`{project_id}`å’Œ`{environment}`
2. æŸ¥è¯¢`projects.{project_id}.{environment}`é…ç½®è·å–webhookåˆ—è¡¨
3. éå†åˆ—è¡¨æ‰§è¡Œè½¬å‘

**ä¼˜ç‚¹**
- æ›´å¥½åœ°æ”¯æŒå¤šé¡¹ç›®å¤šç¯å¢ƒåœºæ™¯
- é…ç½®ç»“æ„å±‚æ¬¡æ¸…æ™°
- æ”¯æŒç¯å¢ƒéš”ç¦»

**ç¼ºç‚¹**
- é…ç½®å¤æ‚åº¦è¾ƒé«˜
- éœ€è¦ç»´æŠ¤å¤šå±‚çº§é…ç½®

---

### æ–¹æ¡ˆä¸‰ï¼šæ··åˆé…ç½®ï¼ˆæ¨èï¼‰

**è·¯ç”±è®¾è®¡**
```
/i/{endpoint_id}/{action?}
```

**é…ç½®ç»“æ„**
```toml
# è·¯ç”±æ˜ å°„é…ç½®
[webhook_endpoints]
# ç®€å•æ˜ å°„ï¼šendpoint -> webhooké…ç½®
"feishu_robot1" = { name = "feishu_robot1" }
"monitor_team" = { name = "monitor_team" }

# å¤æ‚æ˜ å°„ï¼šendpoint -> å¤šä¸ªwebhook
"project_a" = {
  webhooks = ["feishu_prod", "feishu_monitor"],
  strategy = "parallel"  # å¹¶è¡Œè½¬å‘
}

# åŠ¨æ€é…ç½®ï¼šendpoint -> ç¯å¢ƒå˜é‡æ¨¡å¼
"*" = { pattern = "{PROJECT}_{ENV}", strategy = "pattern" }
```

**Webhooké…ç½®**
```toml
[[feishu_webhooks]]
name = "feishu_prod"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/xxx1"
enabled = true

[[feishu_webhooks]]
name = "feishu_monitor"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/xxx2"
enabled = true
```

**è·¯ç”±å¤„ç†é€»è¾‘**
1. è§£æURLè·¯å¾„ï¼Œæå–`{endpoint_id}`
2. ä¼˜å…ˆæŸ¥æ‰¾`webhook_endpoints.{endpoint_id}`é…ç½®
3. å¦‚æœåŒ¹é…åˆ°å•ä¸€webhookï¼Œç›´æ¥è½¬å‘
4. å¦‚æœåŒ¹é…åˆ°å¤šä¸ªwebhooksï¼Œæ‰§è¡Œé…ç½®çš„ç­–ç•¥
5. æ”¯æŒå›é€€åˆ°å…¨å±€åŒ¹é…ï¼ˆ`*`ï¼‰

**ä¼˜ç‚¹**
- çµæ´»é…ç½®ï¼Œæ”¯æŒå¤šç§æ˜ å°„æ–¹å¼
- å‘åå…¼å®¹ç°æœ‰é…ç½®
- æ‰©å±•æ€§å¥½ï¼Œæ”¯æŒåŠ¨æ€é…ç½®

**ç¼ºç‚¹**
- é…ç½®å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜
- éœ€è¦å¤„ç†å¤šç§åŒ¹é…æ¨¡å¼

---

## 4. æ¨èæ–¹æ¡ˆ

### é€‰æ‹©æ–¹æ¡ˆä¸‰ï¼šæ··åˆé…ç½®

**é€‰æ‹©ç†ç”±**

1. **å‘åå…¼å®¹æ€§**ï¼šä¿æŒç°æœ‰é…ç½®æ ¼å¼ä¸å˜ï¼Œé¿å…ç ´åæ€§å˜æ›´
2. **çµæ´»æ‰©å±•**ï¼šæ”¯æŒå¤šç§é…ç½®æ¨¡å¼ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚
3. **æ˜“äºè¿ç§»**ï¼šå¯ä»¥ä»ç®€å•çš„nameåŒ¹é…é€æ­¥è¿ç§»åˆ°å¤æ‚é…ç½®
4. **è¯­ä¹‰æ¸…æ™°**ï¼š`/i/{endpoint_id}`è¯­ä¹‰æ˜ç¡®ï¼Œæ˜“äºç†è§£

### å®æ–½æ­¥éª¤

**é˜¶æ®µ1ï¼šåŸºç¡€è·¯ç”±æ”¯æŒï¼ˆå‘åå…¼å®¹ï¼‰**
- æ·»åŠ åŠ¨æ€è·¯ç”±æ”¯æŒ`/i/{endpoint_id}/{action?}`
- å®ç°åŸºäºnameçš„ç²¾ç¡®åŒ¹é…
- ä¿æŒç°æœ‰`/webhook/glitchtip`ç«¯ç‚¹ï¼ˆæ ‡è®°ä¸ºdeprecatedï¼‰

**é˜¶æ®µ2ï¼šå¤šç›®æ ‡è½¬å‘**
- æ”¯æŒä¸€ä¸ªendpointå¯¹åº”å¤šä¸ªwebhook
- å®ç°è½¬å‘ç­–ç•¥ï¼ˆå¹¶è¡Œã€é¡ºåºã€æ¡ä»¶ï¼‰
- æ·»åŠ è½¬å‘ç­–ç•¥é…ç½®

**é˜¶æ®µ3ï¼šé«˜çº§åŠŸèƒ½**
- æ”¯æŒåŠ¨æ€é…ç½®ï¼ˆåŸºäºç¯å¢ƒå˜é‡ï¼‰
- æ·»åŠ é…ç½®çƒ­é‡è½½
- å®Œå–„ç›‘æ§å’Œæ—¥å¿—

---

## 5. è¿ç§»ç­–ç•¥

### ç°æœ‰ç”¨æˆ·è¿ç§»

1. **ä¿æŒå…¼å®¹**ï¼šä¿ç•™ç°æœ‰é…ç½®å’Œè·¯ç”±æ ¼å¼
2. **é€æ­¥è¿ç§»**ï¼šç”¨æˆ·å¯ä»¥é€æ­¥å°†é…ç½®è¿ç§»åˆ°æ–°çš„è·¯ç”±æ¨¡å¼
3. **é…ç½®éªŒè¯**ï¼šæ·»åŠ é…ç½®éªŒè¯å·¥å…·ï¼Œç¡®ä¿é…ç½®æ­£ç¡®æ€§
4. **æ–‡æ¡£æŒ‡å¯¼**ï¼šæä¾›è¯¦ç»†çš„è¿ç§»æŒ‡å—å’Œç¤ºä¾‹

### ç¤ºä¾‹è¿ç§»

**ç°æœ‰é…ç½®ï¼ˆä¿æŒæœ‰æ•ˆï¼‰**
```toml
[[feishu_webhooks]]
name = "main"
url = "https://..."
enabled = true
```

**æ–°è·¯ç”±ä½¿ç”¨**
```toml
# æ–°çš„endpointæ˜ å°„é…ç½®
[webhook_endpoints]
main = { name = "main" }

[[feishu_webhooks]]
name = "main"
url = "https://..."
enabled = true
```

**ä½¿ç”¨æ–°è·¯ç”±**
- æ—§ï¼š`POST /webhook/glitchtip`ï¼ˆä»æ”¯æŒï¼‰
- æ–°ï¼š`POST /i/main/webhook`

---

## 6. åç»­è§„åˆ’

### çŸ­æœŸè®¡åˆ’
- [ ] å®ç°æ–¹æ¡ˆä¸‰çš„åŸºç¡€åŠŸèƒ½
- [ ] æ·»åŠ é…ç½®éªŒè¯
- [ ] æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### ä¸­æœŸè®¡åˆ’
- [ ] æ”¯æŒæ›´å¤šè½¬å‘ç­–ç•¥
- [ ] æ·»åŠ ç›‘æ§é¢æ¿
- [ ] æ”¯æŒå…¶ä»–IMå¹³å°ï¼ˆé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–

### é•¿æœŸè®¡åˆ’
- [ ] æ”¯æŒåŸºäºè§„åˆ™çš„æ¶ˆæ¯è¿‡æ»¤
- [ ] æ·»åŠ æ¶ˆæ¯èšåˆåŠŸèƒ½
- [ ] æ”¯æŒæ¨¡æ¿åŒ–æ¶ˆæ¯
- [ ] æ”¯æŒæ¶ˆæ¯å›æº¯å’Œé‡æ”¾

---

## é™„å½•

### A. APIè®¾è®¡ç¤ºä¾‹

**æ–°è·¯ç”±æ¥å£**
```http
POST /i/{endpoint_id}/webhook
POST /i/{endpoint_id}/alert
POST /i/{endpoint_id}/notify

# Headers
Content-Type: application/json
X-Project-Id: project_a
X-Environment: production

# Body
{ /* GlitchTip webhook payload */ }
```

**é…ç½®æŸ¥è¯¢æ¥å£**
```http
GET /i/{endpoint_id}/config
# è¿”å›è¯¥endpointçš„é…ç½®ä¿¡æ¯ï¼ˆè„±æ•ï¼‰
```

**å¥åº·æ£€æŸ¥æ¥å£**
```http
GET /i/{endpoint_id}/health
# æ£€æŸ¥è¯¥endpointçš„webhookå¯ç”¨æ€§
```

### B. é…ç½®ç¤ºä¾‹

**å®Œæ•´é…ç½®ç¤ºä¾‹**
```toml
# config.toml

# æœåŠ¡å™¨é…ç½®
server_port = 7876

# Webhookç«¯ç‚¹æ˜ å°„
[webhook_endpoints]
# ç®€å•æ˜ å°„
"team_alerts" = { name = "feishu_team" }
"monitor" = { name = "feishu_monitor" }

# å¤šç›®æ ‡æ˜ å°„
"project_a" = {
  webhooks = ["feishu_dev", "feishu_ops"],
  strategy = "parallel"
}
"project_b" = {
  webhooks = ["feishu_qa"],
  strategy = "first_success"
}

# é£ä¹¦Webhooké…ç½®
[[feishu_webhooks]]
name = "feishu_team"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/TEAM_WEBHOOK"
enabled = true

[[feishu_webhooks]]
name = "feishu_dev"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/DEV_WEBHOOK"
enabled = true

[[feishu_webhooks]]
name = "feishu_ops"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/OPS_WEBHOOK"
enabled = true

[[feishu_webhooks]]
name = "feishu_qa"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/QA_WEBHOOK"
enabled = true

[[feishu_webhooks]]
name = "feishu_monitor"
url = "https://open.feishu.cn/open-apis/bot/v2/hook/MONITOR_WEBHOOK"
enabled = true
```

---

**æ–‡æ¡£çŠ¶æ€ï¼š** å¾…ç¡®è®¤
**ä¸‹æ¬¡æ›´æ–°ï¼š** æ ¹æ®åé¦ˆè°ƒæ•´æ–¹æ¡ˆ

---

## å®æ–½çŠ¶æ€

### âœ… å·²å®ŒæˆåŠŸèƒ½ (2025-11-19)

**é˜¶æ®µ1ï¼šåŸºç¡€åŠŸèƒ½å®ç°**
- [x] æ›´æ–°types.rs - æ·»åŠ WebhookEndpointså’ŒEndpointConfigç»“æ„
- [x] æ›´æ–°config.rs - æ”¯æŒè§£æwebhook_endpointsé…ç½®
- [x] æ›´æ–°config.example.toml - æ·»åŠ æ–°é…ç½®ç¤ºä¾‹
- [x] æ›´æ–°è·¯ç”±å¸¸é‡å®šä¹‰
- [x] æ›´æ–°main.rs - æ·»åŠ æ–°è·¯ç”± `/i/{endpoint_id}/{action?}`
- [x] æ›´æ–°service.rs - å®ç°è·¯ç”±å‚æ•°è§£æå’Œç²¾ç¡®è½¬å‘
- [x] å®ç°å¤šç›®æ ‡è½¬å‘ç­–ç•¥ï¼ˆparallel, first_success, sequentialï¼‰

**åŠŸèƒ½ç‰¹æ€§**
1. âœ… ç®€å•æ˜ å°„ï¼šendpoint_id â†’ å•ä¸ªwebhook
2. âœ… å¤šç›®æ ‡æ˜ å°„ï¼šendpoint_id â†’ å¤šä¸ªwebhooks
3. âœ… å¹¶å‘è½¬å‘ï¼šæ”¯æŒé…ç½®max_concurrentå‚æ•°
4. âœ… è½¬å‘ç­–ç•¥ï¼š
   - parallelï¼šå¹¶å‘è½¬å‘åˆ°æ‰€æœ‰ç›®æ ‡
   - first_successï¼šæˆåŠŸå³åœ
   - sequentialï¼šé¡ºåºæ‰§è¡Œ
5. âœ… å‘åå…¼å®¹ï¼šä¿ç•™ `/webhook/glitchtip` ç«¯ç‚¹

**ç¼–è¯‘çŠ¶æ€**
- âœ… cargo check é€šè¿‡
- âœ… cargo build æ„å»ºæˆåŠŸ
- âœ… æ·»åŠ  futures ä¾èµ–

**æµ‹è¯•çŠ¶æ€**
- ğŸ§ª å•å…ƒæµ‹è¯•ï¼šå¾…è¡¥å……
- ğŸ§ª é›†æˆæµ‹è¯•ï¼šå¾…è¡¥å……
- ğŸ§ª ç«¯åˆ°ç«¯æµ‹è¯•ï¼šå¾…æ‰‹åŠ¨æµ‹è¯•

---

## å˜æ›´æ—¥å¿—

### v2.0 (2025-11-19)
- **æ–°å¢**ï¼šendpoint-basedåŠ¨æ€è·¯ç”±æ”¯æŒ
- **æ–°å¢**ï¼šå¤šç›®æ ‡è½¬å‘ç­–ç•¥
- **æ–°å¢**ï¼šå¹¶å‘è½¬å‘æ§åˆ¶
- **å…¼å®¹**ï¼šä¿æŒv1.0é…ç½®æ ¼å¼å…¼å®¹æ€§
- **ä¼˜åŒ–**ï¼šæ·»åŠ é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**å®æ–½æ—¥æœŸ**ï¼š2025-11-19
**çŠ¶æ€**ï¼šâœ… åŠŸèƒ½å®ç°å®Œæˆï¼Œç­‰å¾…æµ‹è¯•éªŒè¯
